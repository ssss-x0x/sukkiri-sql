# データベースの設計の流れ

データベースでどのようなことを実現したいかの要件をヒアリングし、やりたいことを最終的に DDL に落とし込む。

## 概念設計

- 要件を実現するために、抽象的な概念をどのような塊（エンティティ）で扱うか、情報を整理する。
- 成果物は「ER 図」として書き出すことが多い。
- エンティティの中に入れ子でエンティティが生まれるような「二重構造エンティティ」は作らないようにする（注文と注文明細など）

### 概念設計の要素

- エンティティ: テーブルのようなもの
- 属性: テーブルの列のようなもの
- 関連: リレーションシップのようなもの

### 例: 書店の在庫管理

- エンティティ: 書籍、在庫
- 属性
  - 書籍: 書籍名、出版日、価格など
  - 在庫: 点数、保管場所など
  - 関連: どの「書籍」の「在庫」がいくつあるかを管理したい

### 主なステップ

1. 候補となる用語を洗い出す
1. 不要な用語を捨てる（用語の具体例なワード、計算・集計をすれば算出可能なもの）
1. 関連がありそうなものをまとめる
1. エンティティと属性名に分ける

## 論理設計

- 概念上のエンティティをリレーショナルデータモデルで取り扱いやすい形のテーブルに変形する
- システムに必要なすべてのテーブルと列を漏れなく明らかにする
- 「多対多」のリレーションシップを「1 対多」に変形する
- 主キーには下記の 3 つの特性を持たせるようにする

1. 非 NULL 性: 必ず値を保つこと
1. 一意性: 他と重複しないこと
1. 不変性: 一度登録したら値が変化しないこと

## 正規化

矛盾したデータを格納できないように、テーブルを複数に分割していく。

- テーブルを分割しないと、内容に重複が多くわかりにくい
- データ更新時の影響箇所が複数になるため、データの整合性を保つことが難しい
- テーブルに含まれる主キー以外の列は、主キーが決まればおのずと値が決まるような「関数従属性」となっているようにする

### 正規化の手順

1. 非正規形: 1 列 1 データになっていない状態（1 つの列に複数行の値を持っている、一部列の結合を行っている）
1. 第一正規形: テーブルのすべての行のすべての列に、1 つずつ値が入っている状態を目指す。(非正規形から脱却する)
   1. 繰り返しの列の部分を別のテーブルに切り出す
   1. 切り出したテーブルの仮の主キーを決める
   1. 主キー列をコピーして複合主キーを構成する
1. 第二正規形: 全ての非主キーの列が「複合主キーの全体」に関数従属するようにする
   |入出金 ID|費目 ID|費目名|金額|
   |---|---|---|---|
   |複合主キー|複合主キー|||
   |41001|H01|住居費|65000|
   |41001|H17|振込手数料|525|

   1. 複合主キーの一部に関数従属する列を切り出す
      |入出金 ID|費目 ID|金額|
      |---|---|---|
      |複合主キー|複合主キー||
      |41001|H01|65000|
      |41001|H17|525|

      | 費目名     |
      | ---------- |
      | 住居費     |
      | 振込手数料 |

   1. 部分関数従属している列を別テーブルに切り出し名前をつける
   1. 部分関数従属していた列をコピーし、主キーとする

      | 入出金 ID  | 費目 ID    | 金額  |
      | ---------- | ---------- | ----- |
      | 複合主キー | 複合主キー |       |
      | 41001      | H01        | 65000 |
      | 41001      | H17        | 525   |

      | 費目 ID | 費目名     |
      | ------- | ---------- |
      | H01     | 住居費     |
      | H17     | 振込手数料 |

1. 第三正規形: 非キー列がすべて主キーに直接関数従属するようになる = 主キーに関数従属する列にさらに関数従属する列は存在してはいけない
   |ID|日付|ユーザー ID|名前|ログイン成否|
   |---|---|---|---|---|
   |1|2023-04-14|1|山田一郎|1|
   |2|2023-04-15|1|山田一郎|0|
   |3|2023-04-20|2|山田二郎|1|
   |4|2023-04-22|4|山田三郎|0|
   |5|2023-04-22|4|山田三郎|0|
   |6|2023-04-22|4|山田三郎|1|

   1. 間接的に主キーに関数従属する列を切り出す
      |ID|日付|ユーザー ID|ログイン成否|
      |---|---|---|---|
      |1|2023-04-14|1|1|
      |2|2023-04-15|1|0|
      |3|2023-04-20|2|1|
      |4|2023-04-22|4|0|
      |5|2023-04-22|4|0|
      |6|2023-04-22|4|1|

      | 名前     |
      | -------- |
      | 山田一郎 |
      | 山田二郎 |
      | 山田三郎 |

   1. 直接的に関数従属していた列をコピーし、主キーとする
      |ID|日付|ユーザー ID|ログイン成否|
      |---|---|---|---|
      |1|2023-04-14|1|1|
      |2|2023-04-15|1|0|
      |3|2023-04-20|2|1|
      |4|2023-04-22|4|0|
      |5|2023-04-22|4|0|
      |6|2023-04-22|4|1|

      | ユーザー ID | 名前     |
      | ----------- | -------- |
      | 1           | 山田一郎 |
      | 2           | 山田二郎 |
      | 3           | 山田三郎 |

## 物理設計

- 論理設計が終わった内容に対して、利用する DBMS に合わせた具体的なテーブル設計を行う

1. 最終的なテーブル名・列名を決定する
1. 列の型を決定する
1. 制約・デフォルト値を決定する
1. インデックスを決定する
1. その他（利便性を考慮したビューの作成・テーブルの分割・性能のために正規化をゆるくするなど）
1. …を DDL に落とし込む
