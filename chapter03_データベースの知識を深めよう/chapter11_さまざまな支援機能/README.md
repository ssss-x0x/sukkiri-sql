# データベースのさまざまな支援機能

## インデックスの作成・削除

- データベース内のテーブルに対して、本の「索引」と似たものをつけることができるのが「インデックス」。
- 指定したカラムに対してインデックスを作り、インデックスが存在するカラムに対して検索を行うと、DBMS は自動的にインデックスの使用を試みる。
- インデックスを使用した検索は、インデックスがない場合よりも高速になる場合が多い。
- 使用したインデックスが実際に使用されているかは、SELECT の頭に `EXPLAIN` をつける

#### 参考

- https://dev.mysql.com/doc/refman/8.0/ja/explain.html
- https://qiita.com/tsurumiii/items/0b70f1a1ee0499be2002

```
-- インデックスを作成する
CREATE INDEX インデックス名 ON テーブル名(カラム名);

-- インデックスを削除する
DROP INDEX インデックス名;
```

### インデックスの使用ケース

- 検索の WHERE 句

```
CREATE INDEX idx_memo ON house_account_books(memo);

-- インデックスが有効になるケース
SELECT * FROM house_account_books WHERE memo = '不明';
SELECT * FROM house_account_books WHERE memo LIKE '太郎の%';

-- インデックスが利用されないケース 部分一致検索・後方一致検索
SELECT * FROM house_account_books WHERE memo LIKE '%のお小遣い';
```

- ORDER BY 句

```
CREATE INDEX idx_category_id ON house_account_books(category_id);

SELECT * FROM house_account_books ORDER BY category_id;
```

- JOIN の結合条件に指定

```
CREATE INDEX idx_category_id ON house_account_books(category_id);

SELECT * FROM house_account_books
    JOIN categories ON house_account_books.category_id = categories.id;
```

### インデックスの注意点

- インデックスは索引情報を保存するためにディスク容量を消費する。
- テーブルのデータ変更時にインデックスの情報も書き換えが必要なため、 INSERT, UPDATE, DELETE 時のオーバーヘッドが増える。
- 検索の性能は向上するがデータの書き換え時の処理は増えてしまうため、むやみに増やさないようにする。

---

## ビューの作成とメリット

- 同じような検索を頻繁に実行するケースがある場合、「ビュー」機能を使ってテーブルのようにデータを抽出すると便利。
- 機密情報の含まれているテーブルに対して閲覧制限をかけたい場合に、機密情報を除いたビューを作成することもできる。
- テーブルは権限を持ったメンバーだけ操作可、ビューは一般メンバーでも閲覧可…というようにデータ参照範囲を柔軟に定めることができる。
- ビューの実態はあくまでも「名前をつけた SELECT 文」なので、テーブルのようにデータの操作（登録・更新・削除）はできない。
- たくさんのビューを一度に参照した場合に想像以上に負荷の高い処理を行わせてしまうことになるため注意する。

```
-- ビューの作成
CREATE VIEW ビュー名 AS SELECT文;

-- ビューの削除
DROP VIEW ビュー名;

-- ビューの参照
SELECT * FROM ビュー名;
```

## データベースをより安全に使う

### ACID 属性

データベースが備えるべき 4 つの特性を ACID 属性と呼ぶ。

1. 原始性: 処理が中断しても半端な状態にならない
1. 一貫性: データの内容が矛盾した内容にならない
1. 分離性: 複数の処理を同時実行しても副作用がない
1. 永続性: 記録した情報は消滅せずに保持され続ける
   1. オフラインバックアップ: データベースを停止してからバックアップを行う方法。バックアップ中には一切のデータ処理が止まる＆数時間以上かかるケースもあるので状況によっては利用できない。
   1. オンラインバックアップ: データベースを稼働させながら行うバックアップ。AWS の RDS ではスナップショットが該当する

#### バックアップの組み合わせ

DBMS のログファイルはデータベースを更新したすべての SQL 文が残っているため、消失直前の時点までデータを復旧(ロールフォワード)
することができる。

- データベース: 低頻度（日次・週次・月次など）
- ログファイル: 高頻度（数分ごと〜数時間ごと） などでバックアップの頻度を組み合わせると良い

## 連番を採番するシーケンス

- PostgreSQL などでは「シーケンス」を使用して、現在の値（最後に採番した値）や次の値（次に採番される値）を取り出すことができる。
- シーケンスから値を取り出すと、操作はすぐに確定する。ロールバックしてもシーケンスの値は戻らない。

```
-- シーケンスの作成
CREATE SEQUENCE シーケンス名;

 -- 次の値に進み、その値を取得（採番）
 SELECT NEXTVAL('シーケンス名');

-- 現在の値を取得
 SELECT CURRVAL('シーケンス名');

-- シーケンスの削除
DROP SEQUENCE シーケンス名;
```
