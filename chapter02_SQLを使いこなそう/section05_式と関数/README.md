# 式と関数

SQL では、単なるデータの出し入れだけでなく以下の機能も使うことができる。

- 式を用いることで列の値やリテラルを用いた四則演算
- 関数を用いた引数に応じた処理

## 式と演算子

### SELECT の結果で計算式を使う

- カラム名: 列の内容がそのまま出力される
- 計算式: 計算式の評価結果が出力される
- 固定値: 固定値（リテラル）がそのまま出力される

```
SELECT
*, -- カラム別の値
deposit * 1.1 AS 税込入金額, -- 計算式
'家計簿' AS 固定値サンプル -- 固定値
FROM house_account_books;
```

### INSERT 文での計算式の利用

```
INSERT INTO house_account_books (withdraw) VALUES (withdraw + 100);
```

### UPDATE 文での計算式の利用

```
UPDATE house_account_books SET withdraw = withdraw + 100;
```

## さまざまな演算子

### 基本的な算術演算子

| 演算子 | 使い方             | 説明                                 |
| ------ | ------------------ | ------------------------------------ |
| +      | 数値 + 数値        | 数値同士で足し算                     |
| +      | 日付 + 数値        | 日付を指定日数だけ進める             |
| -      | 数値 - 数値        | 数値同士で引き算                     |
| -      | 日付 + 数値        | 日付を指定日数だけ戻す               |
| \*     | 数値 \* 数値       | 数値同士で掛け算                     |
| /      | 数値 / 数値        | 数値同士で割り算                     |
| ｜｜   | 文字列 ｜｜ 文字列 | 文字列を連結する（｜｜は半角で使う） |

### CASE 演算子

条件式に応じて値を返すことができる演算子

```
-- ある項目に対して値を使う場合
CASE column1
    WHEN 値1 THEN 値1の時に返す値
    WHEN 値2 THEN 値2の時に返す値
    ELSE デフォルト値
END

-- 式を使う場合
CASE WHEN 式1 THEN 値1
     WHEN 式2 THEN 値2
     ELSE デフォルト値
END
```

## 関数

[参考: MySQL の関数](https://dev.mysql.com/doc/refman/8.0/ja/functions.html)

### ユーザー関数とストアドプロシージャ

- 自分で必要な処理を記述して作成した関数を「ユーザー定義関数」と呼ぶ
- 実行する複数の SQL 文をまとめ、データベースの外部から呼び出すものを「ストアドプロシージャ」と呼ぶ。
- ストアドプロシージャを用意することで、データベースとアプリケーション間のやり取りを少なくし、ネットワークの負荷を軽減できる。
- 関数を多く使うことで負荷がかかることやインデックスが無効になるなどの副作用もある。使用時は前もって検証をする必要がある。

### 日付にまつわる関数

| 関数名            | 備考       | サンプル                      |
| ----------------- | ---------- | ----------------------------- |
| CURRENT_TIMESTAMP | 現在の日時 | 2024-02-23 17:46:03.141702+09 |
| CURRENT_DATE      | 現在の日付 | 2024-02-23                    |
| CURRENT_TIME      | 現在の時刻 | 17:46:03.141702+09            |

### さまざまな関数

- SUBSTRING(対象となる文字列, 切り出し開始位置, 切り出す文字数)

```
-- email_address = 'test@example.jp'
SUBSTRING(
    TRIM(email_address),
    LENGTH(TRIM(email_address)) -1,
    2
)
-- result: 'jp'
```

- TRIM(文字列): 前後のスペースを省く
- REPLACE(文字列, 置換前の文字列, 置換後の文字列): 対象の文字列内で置換を行う
