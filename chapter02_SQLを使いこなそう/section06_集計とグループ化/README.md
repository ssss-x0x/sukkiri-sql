# 集計関数

集計の対象となったすべての行に対して 1 回だけ計算を行い、1 つの答えを出す関数。  
（前の章でやった LENGTH, REPLACE は各行のカラムに対して 1 行ずつ実行する関数）

## 代表的な集計関数

| 関数名 | 数値型           | 文字列型               | 日付・時刻型   | NULL の取り扱い                     | 全行が NULL の場合の出力値 |
| ------ | ---------------- | ---------------------- | -------------- | ----------------------------------- | -------------------------- |
| SUM    | 各行の値の合計   | ×                      | ×              | 無視                                | NULL                       |
| MAX    | 各行の値の最大値 | 並び替え最後の文字列   | 最も新しい日時 | 無視                                | NULL                       |
| MIN    | 各行の値の最小値 | 並び替えて最初の文字列 | 最も古い日時   | 無視                                | NULL                       |
| AVG    | 各行の値の平均値 | ×                      | ×              | 無視                                | NULL                       |
| COUNT  | 各行の値の件数   | 行数                   | 行数           | カラム名を指定した場合、無視する。  | 0                          |
|        |                  |                        |                | \*指定の場合、NULL を含んで計算する | 該当する行数               |

### 注意点

1. SELECT 文、ORDER BY 句、HAVING 句の中でしか使用できない。
1. 出力結果では、全行のカラム数が一致していなくてはならない。
1. 引数に対して許容される値が異なる。
1. NULL に対する取り扱いが関数ごとに異なる。

- グループ集計を行う SELECT 文の選択列リストに指定する列は、以下のいずれかに当てはまる必要がある。

1. GROUP BY 句にグループ化の基準列として指定されている
2. 集計関数による集計の対象となっている

## グループ化

指定したカラムでグループ化して、集計結果を出力することができる。

```
SELECT
    category,
    SUM(withdraw) AS 費目ごとの出金額合計
FROM
    house_account_books
WHERE ...絞り込み条件
GROUP BY
    category;
HAVING ...集計結果に対する絞り込み条件
```

:::note warn
元のテーブルに対する絞り込みは WHERE 句で行った方が検索結果を絞り込める。  
WHERE と HAVING を併用する場合は、集計の前に処理行数を減らせないか見直すようにする。
:::

### グループ集計の流れ

1. 元のテーブルから WHERE 句によって行を絞り込む
1. 検索結果から GROUP BY で指定されたグループごとに検索結果を分類する
1. 各グループを集計する・SELECT 句によってカラムを絞り込む
1. 集計結果に対して HAVING で指定された条件で絞り込む

# 集計テーブルの活用

数千万行レベルのデータに対して集計関数を都度実行するとデータベースへの負担や処理時間がかかってしまうことがある。（数万件程度のデータであれば集計はすぐにできるが、多くのユーザーが一度に集計関数を呼び出すと同様の問題が生じる）  
このように大量のデータを扱う場合、集計テーブルを呼ばれるテーブルを用いることがある。

- 集計処理を定期的に実行し、結果を集計テーブルに登録する。データの性質に応じて更新頻度は検討する。
- 集計結果が必要な場合は、すでに作った集計テーブルに格納されている計算済みの集計結果を利用する。
